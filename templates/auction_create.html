{% extends 'base.html' %}

{% block title %}Auctions | {{ title }} {% endblock %}

{% block body %}
    {% include 'sidebar.html' %}

    <div class="container">
        <!-- Page Heading -->
        {% if success %}
            <br>
            <div id='success-alert' class='alert alert-success' role='alert'>
                The new auction created successfully.
            </div>
        {% else %}
            <!-- Option Modal -->
            <div id="optionModal" class="modal">
                <div class="modal-content">
                    <h2>Select an Option</h2>
                    <div class="modal-options">
                        <div class="option" id="scanBarcode">
                            <i class="fa-solid fa-barcode"></i>
                            <h3>Scan Barcode</h3>
                        </div>
                        <div class="option" id="enterDetails">
                            <i class="fa-solid fa-pencil"></i>
                            <h3>Enter Details Manually</h3>
                        </div>
                        <div class="option" id="importExcel">
                            <i class="fa-solid fa-file-excel"></i>
                            <h3>Import Excel</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scan Barcode Modal -->
            <div id="scanModal" class="modal">
                <div class="modal-content">
                    <h2>Scan Barcode or QR Code</h2>
                    <div id="camera-preview" class="camera-preview">
                        <video id="video" width="100%" height="100%" autoplay></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <div class="scan-guide">
                            <div class="brackets"></div>
                            <div class="scan-line"></div>
                        </div>
                    </div>
                    <button id="closeScanModal" class="btn btn-secondary">Close</button>
                </div>
            </div>

            <!-- Import Excel Modal -->
            <div id="importModal" class="modal">
                <div class="modal-content">
                    <h2>Import From Excel</h2>
                    <form id="importForm">
                        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="form-control" required>
                        <div id="previewContainer" style="display:none;">
                            <h3>Preview Data</h3>
                            <table class="table mt-4" id="previewTable">
                                <thead id="previewTableHead">
                                <!-- Dynamic Headers -->
                                </thead>
                                <tbody id="previewTableBody">
                                <!-- Dynamic Rows -->
                                </tbody>
                            </table>
                        </div>
                        <div id="mappingContainer" style="display:none;">
                            <h3>Column Mapping</h3>
                            <table class="table mt-4">
                                <thead>
                                <tr>
                                    <th>File Header</th>
                                    <th></th>
                                    <th>Form Field</th>
                                </tr>
                                </thead>
                                <tbody id="mappingTable">
                                <!-- Dynamic Rows -->
                                </tbody>
                            </table>
                        </div>
                        <div id="import-buttons">
                            <button type="submit" class="btn btn-primary" id="import-button" style="display:none;">
                                Import
                            </button>
                            <button type="button" id="closeImportModal" class="btn btn-secondary">Close</button>
                        </div>
                    </form>
                </div>
            </div>

            <h1 class='h3 mb-4 text-gray-800'>Create Auction</h1>
            <p>Enter the details of the new auction.</p>

            <div class='card mb-4'>
                <div class='card-body'>
                    <div class='form-group'>
                        <form action="{% url 'auction_create' %}" method='POST' enctype='multipart/form-data'>
                            {% csrf_token %}
                            <div class='form-group' id="auction-create">
                                <div class="">
                                    {{ auction_form.title.label_tag }}
                                    {{ auction_form.title }}
                                </div>

                                <div class="bid-details">
                                    <div>
                                        {{ auction_form.category.label_tag }}
                                        {{ auction_form.category }}
                                    </div>
                                    <div class="bid-row">
                                        <div>
                                            {{ auction_form.starting_bid.label_tag }}
                                            {{ auction_form.starting_bid }}
                                        </div>
                                        <div>
                                            {{ auction_form.reserve_bid.label_tag }}
                                            {{ auction_form.reserve_bid }}
                                        </div>
                                    </div>
                                    <div>
                                        {{ auction_form.auction_duration.label_tag }}
                                        {{ auction_form.auction_duration }}
                                    </div>
                                </div>
                                <div class="">
                                    {{ auction_form.description.label_tag }}
                                    {{ auction_form.description }}
                                </div>

                                <!-- Insert the heading here -->
                                <h3 class="package-details-heading">Enter Product Details</h3>

                                <div>
                                    {{ auction_form.manufacturer.label_tag }}
                                    {{ auction_form.manufacturer }}
                                </div>

                                <div>
                                    {{ auction_form.reference_number.label_tag }}
                                    {{ auction_form.reference_number }}
                                </div>

                                <div>
                                    {{ auction_form.lot_number.label_tag }}
                                    {{ auction_form.lot_number }}
                                </div>

                                <div>
                                    {{ auction_form.expiration_date.label_tag }}
                                    {{ auction_form.expiration_date }}
                                </div>

                                <div>
                                    {{ auction_form.package_type.label_tag }}
                                    {{ auction_form.package_type }}
                                </div>

                                <div>
                                    {{ auction_form.package_quantity.label_tag }}
                                    {{ auction_form.package_quantity }}
                                </div>

                                <div class="checkbox-row">
                                    {{ auction_form.deviceSterile.label_tag }}
                                    {{ auction_form.deviceSterile }}
                                </div>
                                <div class="checkbox-row">
                                    {{ auction_form.fullPackage.label_tag }}
                                    {{ auction_form.fullPackage }}
                                </div>

                                {{ image_form.management_form }}
                                <div class="img-container">
                                    <div class="main-img">
                                        <div class="img-thumbnail" id="main-img"
                                             onclick="document.getElementById('id_form-0-image').click()">
                                            <img id="main-thumbnail-preview" src="#" alt="Upload Icon"
                                                 style="display:none;"/>
                                            <i class="fa-regular fa-image" id="main-upload-icon"></i>
                                        </div>
                                        <div style="display:none;">
                                            {{ image_form.forms.0.image.label_tag }}:
                                            {{ image_form.forms.0.image }}
                                            {{ image_form.forms.0.id }}
                                        </div>
                                    </div>
                                    <div class="side-imgs">
                                        {% for form in image_form.forms %}
                                            {% if forloop.counter0 > 0 %}
                                                <div class="side-img">
                                                    <div class="img-thumbnail"
                                                         onclick="document.getElementById('id_form-{{ forloop.counter0 }}-image').click()">
                                                        <img id="thumbnail-preview-{{ forloop.counter0 }}" src="#"
                                                             alt="Upload Icon" style="display:none;"/>
                                                        <i class="fa-regular fa-image"
                                                           id="upload-icon-{{ forloop.counter0 }}"></i>
                                                    </div>
                                                    <div style="display:none;">
                                                        {{ form.image.label_tag }}:
                                                        {{ form.image }}
                                                        {{ form.id }}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>

                                <button type='submit' class='btn btn-primary'>
                                    Save
                                </button>
                                <a href="{% url 'active_auctions_view' %}" class='btn btn-secondary'>
                                    Cancel
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

    <script>
        function readURL(input, previewId, iconId) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById(previewId).src = e.target.result;
                    document.getElementById(previewId).style.display = 'block';
                    document.getElementById(iconId).style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        document.getElementById('id_form-0-image').addEventListener('change', function () {
            readURL(this, 'main-thumbnail-preview', 'main-upload-icon');
        });

        for (let i = 1; i <= 4; i++) {
            document.getElementById('id_form-' + i + '-image').addEventListener('change', function () {
                readURL(this, 'thumbnail-preview-' + i, 'upload-icon-' + i);
            });
        }

        // Show modal on page load
        window.onload = function () {
            document.getElementById('optionModal').style.display = 'block';
        };

        document.getElementById('scanBarcode').onclick = function () {
            document.getElementById('optionModal').style.display = 'none';
            document.getElementById('scanModal').style.display = 'block';
            startScanner();
        };

        document.getElementById('enterDetails').onclick = function () {
            document.getElementById('optionModal').style.display = 'none';
            // Handle Enter Details Manually option
        };

        document.getElementById('importExcel').onclick = function () {
            document.getElementById('optionModal').style.display = 'none';
            document.getElementById('importModal').style.display = 'block';
        };

        document.getElementById('closeImportModal').onclick = function () {
            document.getElementById('importModal').style.display = 'none';
        };

        document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);

        function startScanner() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#video'),
                    constraints: {
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader"]
                }
            }, function (err) {
                if (err) {
                    console.log(err);
                    return;
                }
                console.log("QuaggaJS initialized. Ready to start");
                Quagga.start();
            });

            Quagga.onDetected(function (result) {
                console.log("Barcode detected and processed : [" + result.codeResult.code + "]", result);
                fetchDeviceData(result.codeResult.code);
            });

            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}})
                .then(function (stream) {
                    video.srcObject = stream;
                    video.setAttribute("playsinline", true);
                    video.play();
                    requestAnimationFrame(tick);
                })
                .catch(function (err) {
                    console.error("Error accessing the camera: " + err);
                });

            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight;
                    canvas.width = video.videoWidth;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) {
                        console.log("QR code detected: " + code.data);
                        fetchDeviceData(code.data);
                    }
                }
                requestAnimationFrame(tick);
            }
        }

        function stopScanner() {
            Quagga.stop();
            const video = document.getElementById('video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        function fetchDeviceData(code) {
            fetch(`https://accessgudid.nlm.nih.gov/api/v3/devices/lookup.json?udi=${code}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Device data from AccessGUDID:", data);
                    populateForm(data);
                })
                .catch(error => console.error('Error:', error));

            fetch(`https://api.fda.gov/device/udi.json?search=identifier.id:${code}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Additional data from OpenFDA:", data);
                    populateForm(data);
                })
                .catch(error => console.error('Error:', error));
        }

        function populateForm(data) {
            // Example: document.getElementById('id_manufacturer').value = data.manufacturerName;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(sheet, {header: 1});

                    generatePreviewTable(json);
                    generateMappingTable(json);
                    document.getElementById('import-button').style.display = 'block';
                    document.getElementById('fileInput').style.display = 'none';
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function generatePreviewTable(data) {
            const previewTableHead = document.getElementById('previewTableHead');
            const previewTableBody = document.getElementById('previewTableBody');
            previewTableHead.innerHTML = '';
            previewTableBody.innerHTML = '';

            // Generate table headers
            const headerRow = document.createElement('tr');
            data[0].forEach(header => {
                const th = document.createElement('th');
                th.innerText = header;
                headerRow.appendChild(th);
            });
            previewTableHead.appendChild(headerRow);

            // Generate table rows (limit to 5 rows for preview)
            const previewRows = data.slice(1, 6);
            previewRows.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.innerText = cell;
                    tr.appendChild(td);
                });
                previewTableBody.appendChild(tr);
            });

            document.getElementById('previewContainer').style.display = 'block';
        }

        function generateMappingTable(data) {
            const headers = data[0];
            const formFields = [
                {label: 'Title', value: 'title'},
                {label: 'Description', value: 'description'},
                {label: 'Category', value: 'category'},
                {label: 'Starting Bid', value: 'starting_bid'},
                {label: 'Reserve Bid', value: 'reserve_bid'},
                {label: 'Auction Duration', value: 'auction_duration'},
                {label: 'Manufacturer', value: 'manufacturer'},
                {label: 'Reference Number', value: 'reference_number'},
                {label: 'Lot Number', value: 'lot_number'},
                {label: 'Expiration Date', value: 'expiration_date'},
                {label: 'Package Type', value: 'package_type'},
                {label: 'Package Quantity', value: 'package_quantity'},
                {label: 'Device Sterile', value: 'deviceSterile'},
                {label: 'Full Package', value: 'fullPackage'}
            ];

            const mappingTable = document.getElementById('mappingTable');
            mappingTable.innerHTML = '';

            headers.forEach(header => {
                const row = document.createElement('tr');

                const fileHeaderCell = document.createElement('td');
                fileHeaderCell.innerText = header;
                row.appendChild(fileHeaderCell);

                const arrowCell = document.createElement('td');
                arrowCell.innerHTML = '<i class="fa-solid fa-arrow-right"></i>';
                row.appendChild(arrowCell);

                const formFieldCell = document.createElement('td');
                const select = document.createElement('select');
                select.classList.add('form-control');
                formFields.forEach(field => {
                    const option = document.createElement('option');
                    option.value = field.value;
                    option.innerText = field.label;
                    if (field.label.toLowerCase() === header.toLowerCase()) {
                        option.selected = true; // Auto-select matching fields
                    }
                    select.appendChild(option);
                });
                formFieldCell.appendChild(select);
                row.appendChild(formFieldCell);

                mappingTable.appendChild(row);
            });

            document.getElementById('mappingContainer').style.display = 'block';
        }
    </script>
{% endblock %}
